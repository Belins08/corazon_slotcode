<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hostel Slot Procurement System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="3" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="2" fill="rgba(255,255,255,0.1)"/></svg>');
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .control-group {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
        }

        input, select, button {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .hostel-section {
            padding: 30px;
        }

        .hostel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
        }

        .hostel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .hostel:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .hostel-header {
            padding: 20px;
            background: linear-gradient(45deg, #34495e, #2c3e50);
            color: white;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
        }

        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 2px;
            padding: 20px;
        }

        .room {
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .room::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.6s ease;
        }

        .room:hover::before {
            left: 100%;
        }

        .room.available {
            background: linear-gradient(135deg, #d5f4e6, #a8e6cf);
            border-color: #27ae60;
            color: #155724;
        }

        .room.partial {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-color: #f39c12;
            color: #856404;
        }

        .room.full {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            border-color: #f39c12;
            color: #7d4f00;
        }

        .room.reserved {
            background: linear-gradient(135deg, #fab1a0, #e17055);
            border-color: #e74c3c;
            color: #721c24;
        }

        .room:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .room-code {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .student-name {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .student-id {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .status-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.available {
            background: #27ae60;
        }

        .status-indicator.partial {
            background: #f39c12;
        }

        .status-indicator.full {
            background: #e67e22;
        }

        .status-indicator.reserved {
            background: #e74c3c;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .available-stat { color: #27ae60; }
        .occupied-stat { color: #f39c12; }
        .reserved-stat { color: #e74c3c; }
        .total-stat { color: #3498db; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translate(-50%, -60%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }

        .close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 30px;
            cursor: pointer;
            color: #bdc3c7;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .hostel-grid {
                grid-template-columns: 1fr;
            }
            
            .room-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
        @media (max-width: 900px) {
            .room-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            .modal-content {
                width: 95vw !important;
                min-width: unset !important;
                max-width: 500px !important;
                padding: 10px !important;
            }
            .input-group, .control-group {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 10px !important;
            }
            .input-group input, .input-group select, .input-group button {
                width: 100% !important;
                font-size: 1.1em !important;
                margin-bottom: 8px !important;
            }
            .modal-content input, .modal-content select, .modal-content button {
                width: 100% !important;
                font-size: 1.1em !important;
                margin-bottom: 8px !important;
            }
        }
        @media (max-width: 600px) {
            .room-grid {
                grid-template-columns: 1fr !important;
            }
            .modal-content {
                width: 99vw !important;
                min-width: unset !important;
                max-width: 99vw !important;
                padding: 5px !important;
            }
            .input-group, .control-group {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 8px !important;
            }
            .input-group input, .input-group select, .input-group button {
                width: 100% !important;
                font-size: 1.15em !important;
                margin-bottom: 10px !important;
            }
            .modal-content input, .modal-content select, .modal-content button {
                width: 100% !important;
                font-size: 1.15em !important;
                margin-bottom: 10px !important;
            }
            .header h1 {
                font-size: 1.3em !important;
            }
            .header p {
                font-size: 1em !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏢 El Corazon Hostel</h1>
            <p>Manage room allocations across multiple hostels</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <button id="autoModeBtn" class="btn btn-primary" onclick="setAllocationMode('auto')">Auto</button>
                <button id="manualModeBtn" class="btn btn-secondary" onclick="setAllocationMode('manual')">Manual</button>
            </div>
            <div id="autoForm" style="margin-top: 20px;">
                <div class="input-group">
                    <label for="autoStudentName">Student Name</label>
                    <input type="text" id="autoStudentName" placeholder="Enter student name">
                </div>
                <div class="input-group">
                    <label for="autoGender">Gender</label>
                    <select id="autoGender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="autoHostelSelect">Hostel</label>
                    <select id="autoHostelSelect" onchange="updatePricePreview('auto')">
                        <option value="">Select Hostel</option>
                        <option value="1">Hostel 1 (₵7,200 + ₵400)</option>
                        <option value="2">Hostel 2 (₵7,200-₵7,600 + ₵400)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Price Preview</label>
                    <div id="autoPricePreview" style="padding: 12px 16px; background: #f8f9fa; border-radius: 8px; font-weight: bold; color: #2c3e50;">Select hostel to see pricing</div>
                </div>
                <button class="btn btn-success" onclick="assignAutoSlot()">Procure Slot</button>
            </div>
            <div id="manualForm" style="margin-top: 20px; display: none;">
                <div class="input-group">
                    <label for="manualStudentName">Student Name</label>
                    <input type="text" id="manualStudentName" placeholder="Enter student name">
                </div>
                <div class="input-group">
                    <label for="manualGender">Gender</label>
                    <select id="manualGender" onchange="populateManualRoomOptions()">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="manualHostelSelect">Hostel</label>
                    <select id="manualHostelSelect" onchange="populateManualRoomOptions()">
                        <option value="">Select Hostel</option>
                        <option value="1">Hostel 1</option>
                        <option value="2">Hostel 2</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="manualRoomSelect">Room</label>
                    <select id="manualRoomSelect">
                        <option value="">Select Room</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="assignManualSlot()">Procure Slot</button>
            </div>
            <div class="control-group">
                <button class="btn" onclick="generateReport()">📊 Generate Report</button>
                <button class="btn" onclick="exportData()">📤 Export Data</button>
                <button class="btn btn-danger" onclick="clearAllAllocations()">🗑️ Clear All</button>
            </div>
        </div>

        <div class="hostel-section">
            <div class="stats" id="stats">
                <!-- Stats will be populated here -->
            </div>

            <div class="hostel-grid" id="hostelGrid">
                <!-- Hostels will be populated here -->
            </div>
        </div>
    </div>

    <!-- Modal for room details -->
    <div id="roomModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Room Details</h2>
            <div id="modalContent">
                <!-- Modal content will be populated here -->
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-danger" onclick="vacateRoom()" id="vacateBtn" style="display: none;">Vacate Room</button>
            </div>
        </div>
    </div>

    <script>
        // Hostel data structure
        let hostelData = {
            1: {
                name: "Hostel 1",
                rooms: {}
            },
            2: {
                name: "Hostel 2", 
                rooms: {}
            }
        };

        let currentSelectedRoom = null;

        // Initialize hostels with room data
        function initializeHostels() {
            // Generate rooms for both hostels with proper floor numbering
            // Ground floor: 101-110, First floor: 201-210, Third floor: 301-310
            const floors = [1, 2, 3]; // Ground, First, Third floors
            
            [1, 2].forEach(hostelId => {
                floors.forEach(floor => {
                    const floorPrefix = floor === 1 ? 1 : floor === 2 ? 2 : 3;
                    for (let room = 1; room <= 10; room++) {
                        const roomNumber = `${floorPrefix}${room < 10 ? '0' : ''}${room}`;
                        
                        // Calculate room price based on hostel and floor
                        let roomPrice;
                        if (hostelId === 1) {
                            roomPrice = 7200; // All floors of Hostel 1
                        } else { // Hostel 2
                            if (floor === 1) { // Ground floor
                                roomPrice = 7200;
                            } else { // First and Third floors
                                roomPrice = 7600;
                            }
                        }
                        
                        hostelData[hostelId].rooms[`Room ${roomNumber}`] = {
                            code: generateRoomCode(),
                            student1: null,
                            studentId1: null,
                            tenantCode1: null,
                            student2: null,
                            studentId2: null,
                            tenantCode2: null,
                            status: 'available', // available, partial, full, reserved
                            occupancy: 0,
                            roomPrice: roomPrice,
                            maintenanceFee: 400,
                            gender1: null, // For gender separation
                            gender2: null, // For gender separation
                            paid1: false, paid2: false,
                            paid3: false, paid4: false
                        };
                    }
                });
            });

            // Add special rooms for Hostel 2
            if (hostelData[2]) {
                // Room 211 (3 beds, no price)
                hostelData[2].rooms['Room 211'] = {
                    code: generateRoomCode(),
                    student1: null, student2: null, student3: null,
                    tenantCode1: null, tenantCode2: null, tenantCode3: null,
                    status: 'available', occupancy: 0,
                    roomPrice: null, maintenanceFee: null,
                    gender1: null, gender2: null, gender3: null,
                    paid1: false, paid2: false, paid3: false
                };
                // Room 401 (4 beds, no price)
                hostelData[2].rooms['Room 401'] = {
                    code: generateRoomCode(),
                    student1: null, student2: null, student3: null, student4: null,
                    tenantCode1: null, tenantCode2: null, tenantCode3: null, tenantCode4: null,
                    status: 'available', occupancy: 0,
                    roomPrice: null, maintenanceFee: null,
                    gender1: null, gender2: null, gender3: null, gender4: null,
                    paid1: false, paid2: false, paid3: false, paid4: false
                };
                // Room 402 (2 beds, no price)
                hostelData[2].rooms['Room 402'] = {
                    code: generateRoomCode(),
                    student1: null, student2: null,
                    tenantCode1: null, tenantCode2: null,
                    status: 'available', occupancy: 0,
                    roomPrice: null, maintenanceFee: null,
                    gender1: null, gender2: null,
                    paid1: false, paid2: false
                };
            }

            // Add some sample data
            addSampleData();
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 3; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            code += '-';
            for (let i = 0; i < 4; i++) {
                code += Math.floor(Math.random() * 10);
            }
            return code;
        }

        function generateTenantCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = 'TNT-';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function addSampleData() {
            // No sample data
        }

        function renderHostels() {
            const grid = document.getElementById('hostelGrid');
            grid.innerHTML = '';

            Object.keys(hostelData).forEach(hostelId => {
                const hostel = hostelData[hostelId];
                const hostelDiv = document.createElement('div');
                hostelDiv.className = 'hostel';
                
                hostelDiv.innerHTML = `
                    <div class="hostel-header">${hostel.name}</div>
                    <div class="room-grid" id="rooms-${hostelId}">
                        ${renderRooms(hostelId)}
                    </div>
                `;
                
                grid.appendChild(hostelDiv);
            });

            updateStats();
        }

        function renderRooms(hostelId) {
            const rooms = hostelData[hostelId].rooms;
            return Object.keys(rooms).map(roomKey => {
                const room = rooms[roomKey];
                let displayText = '';
                let priceInfo = '';
                
                if (room.status === 'available') {
                    displayText = 'Available';
                    if (room.roomPrice != null && room.maintenanceFee != null) {
                        priceInfo = `₵${room.roomPrice} + ₵${room.maintenanceFee}`;
                    } else {
                        priceInfo = '';
                    }
                } else if (room.status === 'partial') {
                    displayText = room.student1;
                    priceInfo = '1/2 occupied';
                } else if (room.status === 'full') {
                    displayText = `${room.student1}<br>${room.student2}`;
                    priceInfo = '2/2 occupied';
                } else if (room.status === 'reserved') {
                    displayText = 'Reserved';
                    priceInfo = 'Reserved';
                }
                
                return `
                    <div class="room ${room.status}" onclick="showRoomDetails('${hostelId}', '${roomKey}')">
                        <div class="status-indicator ${room.status}"></div>
                        <div class="room-code">${roomKey}</div>
                        <div class="student-name">${displayText}</div>
                        <div class="student-id">${priceInfo}</div>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            let totalRooms = 0;
            let availableRooms = 0;
            let partialRooms = 0;
            let fullRooms = 0;
            let reservedRooms = 0;

            Object.values(hostelData).forEach(hostel => {
                Object.values(hostel.rooms).forEach(room => {
                    totalRooms++;
                    switch(room.status) {
                        case 'available': availableRooms++; break;
                        case 'partial': partialRooms++; break;
                        case 'full': fullRooms++; break;
                        case 'reserved': reservedRooms++; break;
                    }
                });
            });

            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number total-stat">${totalRooms}</div>
                    <div class="stat-label">Total Rooms</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number available-stat">${availableRooms}</div>
                    <div class="stat-label">Available</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number occupied-stat">${partialRooms}</div>
                    <div class="stat-label">Partial (1/2)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number occupied-stat">${fullRooms}</div>
                    <div class="stat-label">Full (2/2)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number reserved-stat">${reservedRooms}</div>
                    <div class="stat-label">Reserved</div>
                </div>
            `;
        }

        function procureSlot() {
            const studentName = document.getElementById('studentName').value.trim();
            const hostelId = document.getElementById('hostelSelect').value;

            if (!studentName || !hostelId) {
                alert('Please fill in all fields');
                return;
            }

            // Check if student already has a room
            for (let hId in hostelData) {
                for (let roomKey in hostelData[hId].rooms) {
                    const room = hostelData[hId].rooms[roomKey];
                    if (room.studentId1 === 'RESERVED' || room.studentId2 === 'RESERVED') { // Check for reserved status
                        alert(`Student ${studentName} already has a bed in ${roomKey} in Hostel ${hId}`);
                        return;
                    }
                }
            }

            // Find first available bed in selected hostel (prioritize partial rooms for pairing)
            const hostel = hostelData[hostelId];
            let assignedRoom = null;
            let tenantCode = generateTenantCode();

            // First, try to fill partial rooms
            for (let roomKey in hostel.rooms) {
                const room = hostel.rooms[roomKey];
                if (room.status === 'partial') {
                    room.student2 = studentName;
                    room.studentId2 = 'STU-' + Math.floor(Math.random() * 1000000); // Generate a dummy ID
                    room.tenantCode2 = tenantCode;
                    room.status = 'full';
                    room.occupancy = 2;
                    assignedRoom = roomKey;
                    break;
                }
            }

            // If no partial rooms, assign to available room
            if (!assignedRoom) {
                for (let roomKey in hostel.rooms) {
                    const room = hostel.rooms[roomKey];
                    if (room.status === 'available') {
                        room.student1 = studentName;
                        room.studentId1 = 'STU-' + Math.floor(Math.random() * 1000000); // Generate a dummy ID
                        room.tenantCode1 = tenantCode;
                        room.status = 'partial';
                        room.occupancy = 1;
                        assignedRoom = roomKey;
                        break;
                    }
                }
            }

            if (assignedRoom) {
                const room = hostelData[hostelId].rooms[assignedRoom];
                const bedNumber = room.occupancy === 1 ? 'Bed 1' : 'Bed 2';
                const totalCost = room.roomPrice + room.maintenanceFee;
                
                alert(`Successfully assigned ${assignedRoom} ${bedNumber} in Hostel ${hostelId} to ${studentName}\n\nTenant Code: ${tenantCode}\nRoom Fee: ₵${room.roomPrice}\nMaintenance Fee: ₵${room.maintenanceFee}\nTotal Cost: ₵${totalCost}`);
                
                document.getElementById('studentName').value = '';
                renderHostels();
            } else {
                alert(`No available beds in Hostel ${hostelId}`);
            }
        }

        function showRoomDetails(hostelId, roomKey) {
            const room = hostelData[hostelId].rooms[roomKey];
            currentSelectedRoom = {hostelId, roomKey};

            const modal = document.getElementById('roomModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const vacateBtn = document.getElementById('vacateBtn');

            modalTitle.textContent = `${roomKey} - Hostel ${hostelId}`;
            let statusColor = room.status === 'available' ? '#27ae60' : 
                            room.status === 'partial' ? '#f39c12' :
                            room.status === 'full' ? '#e67e22' : '#e74c3c';

            // Determine number of beds
            let bedCount = 2;
            if ('student3' in room) bedCount = 3;
            if ('student4' in room) bedCount = 4;

            // Build bed assignment UI
            let bedsHtml = '';
            for (let i = 1; i <= bedCount; i++) {
                const student = room[`student${i}`];
                const tenantCode = room[`tenantCode${i}`];
                const paid = room[`paid${i}`];
                if (student) {
                    const paidIcon = paid ? '<span title="Paid" style="color:green;font-size:1.2em;">✔️</span>' : '<span title="Unpaid" style="color:red;font-size:1.2em;">❌</span>';
                    const paidBtn = `<button onclick="togglePaidStatus(${i})">Mark as ${paid ? 'Unpaid' : 'Paid'}</button>`;
                    const removeBtn = `<button onclick="removeTenant(${i})" style="color:red;">Remove</button>`;
                    bedsHtml += `<p><strong>🛏️ Bed ${i}:</strong> ${student} ${paidIcon} ${paidBtn} ${removeBtn}<br><small style="color: #666;">Tenant Code: ${tenantCode}</small></p>`;
                } else {
                    bedsHtml += `<div style="margin-bottom:8px;"><strong>🛏️ Bed ${i}:</strong> <input type="text" id="assignBed${i}Name" placeholder="Enter student name"> <select id="assignBed${i}Gender"><option value="">Gender</option><option value="male">Male</option><option value="female">Female</option></select> <button onclick="assignToBed(${i})">Assign</button></div>`;
                }
            }

            const totalCost = room.roomPrice + room.maintenanceFee;

            modalContent.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p><strong>Room Code:</strong> ${room.code}</p>
                    <p><strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${room.status.toUpperCase()}</span></p>
                    <p><strong>Occupancy:</strong> ${room.occupancy}/${bedCount}</p>
                    <hr style="margin: 15px 0;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #2c3e50;">💰 Pricing Information</h4>
                        <p><strong>Room Fee:</strong> ₵${room.roomPrice ? room.roomPrice.toLocaleString() : 'N/A'}</p>
                        <p><strong>Maintenance Fee:</strong> ₵${room.maintenanceFee ? room.maintenanceFee.toLocaleString() : 'N/A'}</p>
                        <p><strong>Total per Student:</strong> <span style="color: #e74c3c; font-weight: bold;">₵${totalCost ? totalCost.toLocaleString() : 'N/A'}</span></p>
                    </div>
                    <hr style="margin: 15px 0;">
                    ${bedsHtml}
                </div>
            `;
            if (room.status === 'partial' || room.status === 'full') {
                vacateBtn.style.display = 'inline-block';
                vacateBtn.textContent = room.status === 'full' ? 'Manage Occupants' : 'Vacate Room';
            } else {
                vacateBtn.style.display = 'none';
            }
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('roomModal').style.display = 'none';
            currentSelectedRoom = null;
        }

        function vacateRoom() {
            if (!currentSelectedRoom) return;

            const {hostelId, roomKey} = currentSelectedRoom;
            const room = hostelData[hostelId].rooms[roomKey];

            if (room.status === 'full') {
                // For full rooms, ask which student to remove
                const choice = confirm(`Room has 2 students:\nBed 1: ${room.student1} (${room.tenantCode1})\nBed 2: ${room.student2} (${room.tenantCode2})\n\nClick OK to remove Bed 1 student, Cancel to remove Bed 2 student`);
                
                if (choice) {
                    // Remove student 1, move student 2 to bed 1
                    room.student1 = room.student2;
                    room.studentId1 = room.studentId2;
                    room.tenantCode1 = room.tenantCode2;
                    room.student2 = null;
                    room.studentId2 = null;
                    room.tenantCode2 = null;
                } else {
                    // Remove student 2
                    room.student2 = null;
                    room.studentId2 = null;
                    room.tenantCode2 = null;
                }
                room.status = 'partial';
                room.occupancy = 1;
            } else if (room.status === 'partial') {
                // Vacate the single student
                if (confirm(`Are you sure you want to vacate ${roomKey} for ${room.student1} (${room.tenantCode1})?`)) {
                    room.student1 = null;
                    room.studentId1 = null;
                    room.tenantCode1 = null;
                    room.status = 'available';
                    room.occupancy = 0;
                }
            }

            renderHostels();
            closeModal();
            alert('Room updated successfully');
        }

        function clearAllAllocations() {
            if (confirm('Are you sure you want to clear all room allocations? This cannot be undone.')) {
                Object.values(hostelData).forEach(hostel => {
                    Object.values(hostel.rooms).forEach(room => {
                        room.student1 = null;
                        room.studentId1 = null;
                        room.tenantCode1 = null;
                        room.student2 = null;
                        room.studentId2 = null;
                        room.tenantCode2 = null;
                        room.status = 'available';
                        room.occupancy = 0;
                        room.gender1 = null;
                        room.gender2 = null;
                        room.paid1 = false;
                        room.paid2 = false;
                        room.paid3 = false;
                        room.paid4 = false;
                    });
                });
                renderHostels();
                alert('All allocations cleared - all slots are now vacant');
            }
        }

        function generateReport() {
            let report = 'HOSTEL ALLOCATION REPORT\n';
            report += '=' + '='.repeat(50) + '\n\n';

            let grandTotalRevenue = 0;
            let grandTotalStudents = 0;

            Object.keys(hostelData).forEach(hostelId => {
                const hostel = hostelData[hostelId];
                report += `${hostel.name}:\n`;
                report += '-'.repeat(30) + '\n';

                let totalStudents = 0;
                let totalBeds = Object.keys(hostel.rooms).length * 2;
                let hostelRevenue = 0;
                
                Object.keys(hostel.rooms).forEach(roomKey => {
                    const room = hostel.rooms[roomKey];
                    if (room.status === 'partial' || room.status === 'full') {
                        const totalCost = room.roomPrice + room.maintenanceFee;
                        report += `${roomKey} (${room.occupancy}/2) - ₵${room.roomPrice} + ₵${room.maintenanceFee} = ₵${totalCost} per student:\n`;
                        
                        if (room.student1) {
                            report += `  Bed 1: ${room.student1} (${room.studentId1}) - Tenant: ${room.tenantCode1}\n`;
                            totalStudents++;
                            hostelRevenue += totalCost;
                        }
                        if (room.student2) {
                            report += `  Bed 2: ${room.student2} (${room.studentId2}) - Tenant: ${room.tenantCode2}\n`;
                            totalStudents++;
                            hostelRevenue += totalCost;
                        }
                        report += '\n';
                    }
                });

                report += `Total Students: ${totalStudents}/${totalBeds} beds\n`;
                report += `Occupancy Rate: ${((totalStudents/totalBeds)*100).toFixed(1)}%\n`;
                report += `Total Revenue: ₵${hostelRevenue.toLocaleString()}\n\n`;
                
                grandTotalRevenue += hostelRevenue;
                grandTotalStudents += totalStudents;
            });

            report += '=' + '='.repeat(50) + '\n';
            report += `GRAND TOTALS:\n`;
            report += `Total Students Across All Hostels: ${grandTotalStudents}\n`;
            report += `Total Revenue Generated: ₵${grandTotalRevenue.toLocaleString()}\n`;
            report += `Average Revenue per Student: ₵${grandTotalStudents > 0 ? (grandTotalRevenue/grandTotalStudents).toLocaleString() : 0}\n`;

            // Create downloadable report
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hostel_allocation_report.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportData() {
            const data = JSON.stringify(hostelData, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hostel_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Allocation mode logic
        let allocationMode = 'auto';
        function setAllocationMode(mode) {
            allocationMode = mode;
            document.getElementById('autoForm').style.display = mode === 'auto' ? '' : 'none';
            document.getElementById('manualForm').style.display = mode === 'manual' ? '' : 'none';
            document.getElementById('autoModeBtn').classList.toggle('btn-primary', mode === 'auto');
            document.getElementById('autoModeBtn').classList.toggle('btn-secondary', mode !== 'auto');
            document.getElementById('manualModeBtn').classList.toggle('btn-primary', mode === 'manual');
            document.getElementById('manualModeBtn').classList.toggle('btn-secondary', mode !== 'manual');
        }
        // Update price preview for auto form
        function updatePricePreview(form) {
            let hostelId = '';
            let previewId = '';
            if (form === 'auto') {
                hostelId = document.getElementById('autoHostelSelect').value;
                previewId = 'autoPricePreview';
            } else {
                hostelId = document.getElementById('manualHostelSelect').value;
                previewId = 'manualPricePreview';
            }
            let priceText = 'Select hostel to see pricing';
            if (hostelId === '1') priceText = '₵7,200 + ₵400';
            if (hostelId === '2') priceText = '₵7,200-₵7,600 + ₵400';
            document.getElementById(previewId).textContent = priceText;
        }
        // Populate manual room options based on hostel
        function populateManualRoomOptions() {
            const hostelId = document.getElementById('manualHostelSelect').value;
            const gender = document.getElementById('manualGender').value;
            const roomSelect = document.getElementById('manualRoomSelect');
            roomSelect.innerHTML = '<option value="">Select Room</option>';
            if (!hostelId || !gender) return;
            const rooms = hostelData[hostelId].rooms;
            for (const roomKey in rooms) {
                if (isFemaleForbiddenRoom(roomKey, gender)) continue;
                const room = rooms[roomKey];
                if (room.status === 'full') continue;
                // Gender separation: only show rooms that are empty or have only same-gender occupants
                let occupantsGender = [];
                if (room.gender1) occupantsGender.push(room.gender1);
                if (room.gender2) occupantsGender.push(room.gender2);
                if (occupantsGender.length > 0 && occupantsGender.some(g => g !== gender)) continue;
                // Gather occupant names
                let occupants = [];
                if (room.student1) occupants.push(room.student1);
                if (room.student2) occupants.push(room.student2);
                let occupantsText = occupants.length > 0 ? occupants.join(', ') : 'Empty';
                // Show price details
                let priceText = `₵${room.roomPrice} + ₵${room.maintenanceFee}`;
                // Option text
                let optionText = `${roomKey} (${room.occupancy}/2) - [${occupantsText}] | ${priceText}`;
                roomSelect.innerHTML += `<option value="${roomKey}">${optionText}</option>`;
            }
        }
        // Auto allocation logic
        function assignAutoSlot() {
            const studentName = document.getElementById('autoStudentName').value.trim();
            const gender = document.getElementById('autoGender').value;
            const hostelId = document.getElementById('autoHostelSelect').value;
            if (!studentName || !hostelId || !gender) {
                alert('Please fill in all fields');
                return;
            }
            const hostel = hostelData[hostelId];
            let assignedRoom = null;
            let tenantCode = generateTenantCode();
            let assignedBed = null;
            // Try to fill partial rooms first
            for (let roomKey in hostel.rooms) {
                if (isFemaleForbiddenRoom(roomKey, gender)) continue;
                const room = hostel.rooms[roomKey];
                if (room.status === 'partial') {
                    // Gender separation: only assign if existing occupant is same gender
                    if ((room.gender1 && room.gender1 !== gender) || (room.gender2 && room.gender2 !== gender)) continue;
                    room.student2 = studentName;
                    room.tenantCode2 = tenantCode;
                    room.gender2 = gender;
                    room.status = 'full';
                    room.occupancy = 2;
                    assignedRoom = roomKey;
                    assignedBed = 2;
                    break;
                }
            }
            // If no partial rooms, assign to available room
            if (!assignedRoom) {
                for (let roomKey in hostel.rooms) {
                    if (isFemaleForbiddenRoom(roomKey, gender)) continue;
                    const room = hostel.rooms[roomKey];
                    if (room.status === 'available') {
                        room.student1 = studentName;
                        room.tenantCode1 = tenantCode;
                        room.gender1 = gender;
                        room.status = 'partial';
                        room.occupancy = 1;
                        assignedRoom = roomKey;
                        assignedBed = 1;
                        break;
                    }
                }
            }
            if (assignedRoom) {
                alert(`Assigned ${studentName} to ${assignedRoom} (Bed ${assignedBed}) in Hostel ${hostelId}.\nTenant Token: ${tenantCode}`);
                document.getElementById('autoStudentName').value = '';
                document.getElementById('autoGender').value = '';
                renderHostels();
            } else {
                alert('No available beds in selected hostel for the selected gender');
            }
        }
        // Manual allocation logic
        function assignManualSlot() {
            const studentName = document.getElementById('manualStudentName').value.trim();
            const gender = document.getElementById('manualGender').value;
            const hostelId = document.getElementById('manualHostelSelect').value;
            const roomKey = document.getElementById('manualRoomSelect').value;
            if (!studentName || !hostelId || !roomKey || !gender) {
                alert('Please fill in all fields');
                return;
            }
            if (isFemaleForbiddenRoom(roomKey, gender)) {
                alert('Females cannot be assigned to rooms 301-310.');
                return;
            }
            const room = hostelData[hostelId].rooms[roomKey];
            // Gender separation: only assign if room is empty or all occupants are same gender
            let occupantsGender = [];
            if (room.gender1) occupantsGender.push(room.gender1);
            if (room.gender2) occupantsGender.push(room.gender2);
            if (occupantsGender.length > 0 && occupantsGender.some(g => g !== gender)) {
                alert('Cannot mix genders in a room.');
                return;
            }
            const tenantCode = generateTenantCode();
            let assignedBed = null;
            if (!room.student1) {
                room.student1 = studentName;
                room.tenantCode1 = tenantCode;
                room.gender1 = gender;
                room.status = room.student2 ? 'partial' : 'partial';
                room.occupancy = room.student2 ? 2 : 1;
                assignedBed = 1;
            } else if (!room.student2) {
                room.student2 = studentName;
                room.tenantCode2 = tenantCode;
                room.gender2 = gender;
                room.status = 'full';
                room.occupancy = 2;
                assignedBed = 2;
            } else {
                alert('Room is already full');
                return;
            }
            alert(`Assigned ${studentName} to ${roomKey} (Bed ${assignedBed}) in Hostel ${hostelId}.\nTenant Token: ${tenantCode}`);
            document.getElementById('manualStudentName').value = '';
            document.getElementById('manualGender').value = '';
            document.getElementById('manualHostelSelect').value = '';
            document.getElementById('manualRoomSelect').innerHTML = '<option value="">Select Room</option>';
            renderHostels();
        }

        // Add assignToBed function for admin assignment
        function assignToBed(bedNumber) {
            if (!currentSelectedRoom) return;
            const {hostelId, roomKey} = currentSelectedRoom;
            const room = hostelData[hostelId].rooms[roomKey];
            const inputId = `assignBed${bedNumber}Name`;
            const studentName = document.getElementById(inputId).value.trim();
            const genderId = `assignBed${bedNumber}Gender`;
            let gender = '';
            const genderInput = document.getElementById(genderId);
            if (genderInput) {
                gender = genderInput.value;
            } else {
                gender = prompt('Enter gender for this bed (male/female):', '');
                if (!gender || (gender !== 'male' && gender !== 'female')) {
                    alert('Please enter a valid gender (male or female)');
                    return;
                }
            }
            if (isFemaleForbiddenRoom(roomKey, gender)) {
                alert('Females cannot be assigned to rooms 301-310.');
                return;
            }
            if (!studentName) {
                alert('Please enter a student name');
                return;
            }
            const tenantCode = generateTenantCode();
            // Gender separation: only assign if room is empty or all occupants are same gender
            let occupantsGender = [];
            for (let i = 1; i <= 4; i++) {
                if (i !== bedNumber && room[`gender${i}`]) occupantsGender.push(room[`gender${i}`]);
            }
            if (occupantsGender.length > 0 && occupantsGender.some(g => g !== gender)) {
                alert('Cannot mix genders in a room.');
                return;
            }
            if (!room[`student${bedNumber}`]) {
                room[`student${bedNumber}`] = studentName;
                room[`tenantCode${bedNumber}`] = tenantCode;
                room[`gender${bedNumber}`] = gender;
                room[`paid${bedNumber}`] = false; // Set paid status to false on assignment
            } else {
                alert('Bed already occupied');
                return;
            }
            // Update room status and occupancy
            let totalBeds = 2;
            if ('student3' in room) totalBeds = 3;
            if ('student4' in room) totalBeds = 4;
            let occ = 0;
            for (let i = 1; i <= totalBeds; i++) {
                if (room[`student${i}`]) occ++;
            }
            room.occupancy = occ;
            if (occ === totalBeds) {
                room.status = 'full';
            } else if (occ > 0) {
                room.status = 'partial';
            } else {
                room.status = 'available';
            }
            renderHostels();
            showRoomDetails(hostelId, roomKey);
            alert(`Assigned ${studentName} to Bed ${bedNumber} in ${roomKey}`);
        }

        // Add togglePaidStatus function
        function togglePaidStatus(bedNumber) {
            if (!currentSelectedRoom) return;
            const {hostelId, roomKey} = currentSelectedRoom;
            const room = hostelData[hostelId].rooms[roomKey];
            if (room[`student${bedNumber}`]) {
                // Only send to Google Sheets if marking as paid
                if (!room[`paid${bedNumber}`]) {
                    fetch('https://script.google.com/macros/s/AKfycbxefTGjAGefmZNS9dVaCbBaoQLFVYzmw9OFUKl7d-a9N-AkIl6YN0GTpRxwZPupacRa/exec', {
                        method: 'POST',
                        body: JSON.stringify({
                            name: room[`student${bedNumber}`],
                            room: roomKey,
                            hostel: hostelId,
                            token: room[`tenantCode${bedNumber}`]
                        }),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                }
                room[`paid${bedNumber}`] = !room[`paid${bedNumber}`];
                showRoomDetails(hostelId, roomKey);
            }
        }

        // Add removeTenant function
        function removeTenant(bedNumber) {
            if (!currentSelectedRoom) return;
            const {hostelId, roomKey} = currentSelectedRoom;
            const room = hostelData[hostelId].rooms[roomKey];
            room[`student${bedNumber}`] = null;
            room[`tenantCode${bedNumber}`] = null;
            room[`gender${bedNumber}`] = null;
            room[`paid${bedNumber}`] = false;
            // Update room status and occupancy
            let totalBeds = 2;
            if ('student3' in room) totalBeds = 3;
            if ('student4' in room) totalBeds = 4;
            let occ = 0;
            for (let i = 1; i <= totalBeds; i++) {
                if (room[`student${i}`]) occ++;
            }
            room.occupancy = occ;
            if (occ === totalBeds) {
                room.status = 'full';
            } else if (occ > 0) {
                room.status = 'partial';
            } else {
                room.status = 'available';
            }
            renderHostels();
            showRoomDetails(hostelId, roomKey);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('roomModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize the system
        initializeHostels();
        renderHostels();

        // Helper to check if room is forbidden for females
        function isFemaleForbiddenRoom(roomKey, gender) {
            if (gender !== 'female') return false;
            const match = roomKey.match(/^Room (\d{3})$/);
            if (match) {
                const num = parseInt(match[1], 10);
                if (num >= 301 && num <= 310) return true;
            }
            return false;
        }
    </script>
</body>
</html>
