<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Hostel Slot Procurement System</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Authentication Container -->
    <div id="authContainer" style="display: none;">
        <div class="auth-wrapper">
            <div class="auth-box">
                <h2>üè¢ El Corazon Hostel</h2>
                <p>Please sign in to access the hostel management system</p>
                
                <!-- Login Form -->
                <div id="loginForm">
                    <h3>Sign In</h3>
                    <div class="input-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email">
                    </div>
                    <div class="input-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <button class="btn btn-primary" onclick="login()">Sign In</button>
                    <p>Don't have an account? <a href="#" onclick="showRegister()">Register here</a></p>
                </div>
                
                <!-- Register Form -->
                <div id="registerForm" style="display: none;">
                    <h3>Create Account</h3>
                    <div class="input-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" placeholder="Enter your email">
                    </div>
                    <div class="input-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" placeholder="Enter your password">
                    </div>
                    <button class="btn btn-success" onclick="register()">Create Account</button>
                    <p>Already have an account? <a href="#" onclick="showLogin()">Sign in here</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="mainContainer" style="display: none;">
        <div class="container">
            <div class="header">
                <h1>üè¢ El Corazon Hostel</h1>
                <p>Manage room allocations across multiple hostels</p>
                <div id="userInfo" style="margin-top: 10px; font-size: 0.9em;"></div>
                <button class="btn btn-danger" onclick="logout()" style="margin-top: 10px;">Logout</button>
            </div>

        <div class="controls">
            <div class="control-group">
                <button id="autoModeBtn" class="btn btn-primary" onclick="setAllocationMode('auto')">Auto</button>
                <button id="manualModeBtn" class="btn btn-secondary" onclick="setAllocationMode('manual')">Manual</button>
            </div>
            
            <!-- Search Section -->
            <div class="search-section">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search students, rooms, tenant codes..." onkeyup="performSearch()">
                    <button class="btn" onclick="performSearch()">üîç Search</button>
                    <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
                </div>
                <div id="searchResults" class="search-results" style="display: none;">
                    <!-- Search results will appear here -->
                </div>
            </div>
            
            <div id="autoForm" style="margin-top: 20px;">
                <div class="input-group">
                    <label for="autoStudentName">Student Name</label>
                    <input type="text" id="autoStudentName" placeholder="Enter student name">
                </div>
                <div class="input-group">
                    <label for="autoGender">Gender</label>
                    <select id="autoGender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="autoHostelSelect">Hostel</label>
                    <select id="autoHostelSelect" onchange="updatePricePreview('auto')">
                        <option value="">Select Hostel</option>
                        <option value="1">Hostel 1 (‚Çµ7,200 + ‚Çµ400)</option>
                        <option value="2">Hostel 2 (‚Çµ7,200-‚Çµ7,600 + ‚Çµ400)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Price Preview</label>
                    <div id="autoPricePreview" style="padding: 12px 16px; background: #f8f9fa; border-radius: 8px; font-weight: bold; color: #2c3e50;">Select hostel to see pricing</div>
                </div>
                <button class="btn btn-success" onclick="assignAutoSlot()">Procure Slot</button>
            </div>
            <div id="manualForm" style="margin-top: 20px; display: none;">
                <div class="input-group">
                    <label for="manualStudentName">Student Name</label>
                    <input type="text" id="manualStudentName" placeholder="Enter student name">
                </div>
                <div class="input-group">
                    <label for="manualGender">Gender</label>
                    <select id="manualGender" onchange="populateManualRoomOptions()">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="manualHostelSelect">Hostel</label>
                    <select id="manualHostelSelect" onchange="populateManualRoomOptions()">
                        <option value="">Select Hostel</option>
                        <option value="1">Hostel 1</option>
                        <option value="2">Hostel 2</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="manualRoomSelect">Room</label>
                    <select id="manualRoomSelect">
                        <option value="">Select Room</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="assignManualSlot()">Procure Slot</button>
            </div>
            <div class="control-group">
                <button class="btn" onclick="generateReport()">üìä Generate Report</button>
                <button class="btn" onclick="exportData()">üì§ Export Data</button>
                <button class="btn" onclick="exportExcel()">üì• Export to Excel</button>
                <button class="btn btn-danger" onclick="clearAllAllocations()">üóëÔ∏è Clear All</button>
            </div>
        </div>

        <div class="hostel-section">
            <div class="pull-refresh" id="pullRefresh">Pull down to refresh</div>
            <div class="stats" id="stats">
                <!-- Stats will be populated here -->
            </div>

            <div class="hostel-grid" id="hostelGrid">
                <!-- Hostels will be populated here -->
            </div>
        </div>
    </div>

    <!-- Modal for room details -->
    <div id="roomModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Room Details</h2>
            <div id="modalContent">
                <!-- Modal content will be populated here -->
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-danger" onclick="vacateRoom()" id="vacateBtn" style="display: none;">Vacate Room</button>
            </div>
        </div>
    </div>

    <!-- Mobile Floating Action Button -->
    <button class="fab" id="mobileFab" onclick="showMobileMenu()" style="display: none;">+</button>

    <!-- Mobile Menu Modal -->
    <div id="mobileMenuModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMobileMenu()">&times;</span>
            <h2>Quick Actions</h2>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <button class="btn btn-success" onclick="quickAssign()">Quick Assign</button>
                <button class="btn" onclick="showStats()">View Statistics</button>
                <button class="btn" onclick="exportData()">Export Data</button>
                <button class="btn btn-danger" onclick="clearAllAllocations()">Clear All</button>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading" id="loadingIndicator">
        <div style="text-align: center;">
            <div style="font-size: 24px; margin-bottom: 10px;">üîÑ</div>
            <div>Loading...</div>
        </div>
    </div>

    <!-- External Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Firebase Configuration and Authentication -->
    <script>
        // Declare Firebase variables in global scope
        let auth;
        let db;
        
        // Firebase configuration - Replace with your Firebase project config
        const firebaseConfig = {
            apiKey: "AIzaSyD9olGjCq2R5Ty-innj4b0ZSnJn-ztFV2I",
            authDomain: "el-corazonslots.firebaseapp.com",
            projectId: "el-corazonslots",
            storageBucket: "el-corazonslots.firebasestorage.app",
            messagingSenderId: "745745248762",
            appId: "1:745745248762:web:752704c94963518b1c7443",
            measurementId: "G-7Q0RQHVXX2"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore(); // Initialize Firestore
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Function to check if Firebase is initialized
        function isFirebaseInitialized() {
            return auth && db;
        }

        // Authentication state observer
        if (auth) {
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    // User is signed in
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    document.getElementById('userInfo').textContent = `Welcome, ${user.email}`;
                    
                    // Initialize the hostel system only when user is authenticated
                    initializeHostels();
                    // Load persistent data from Google Sheets and update hostelData
                    fetch('https://script.google.com/macros/s/AKfycbxv62y2XpoapxBe_TMip29gS5VJBHUwYuDnmZIjYWZkCwd52Fs57bNiUkUrOecW9ZA2/exec')
                      .then(response => response.json())
                      .then(data => {
                        data.forEach(entry => {
                          // Convert Hostel and Room Number to match your keys
                          const hostelId = entry.Hostel;
                          const roomKey = `Room ${entry["Room Number"]}`;
                          // Find the first empty bed in the room
                          const room = hostelData[hostelId] && hostelData[hostelId].rooms[roomKey];
                          if (room) {
                            for (let i = 1; i <= 4; i++) {
                              if (room[`student${i}`] === null || room[`student${i}`] === undefined) {
                                room[`student${i}`] = entry.Name;
                                room[`tenantCode${i}`] = entry.Token;
                                room[`paid${i}`] = true; // Assume paid if it's in the sheet
                                room.occupancy = (room.occupancy || 0) + 1;
                                room.status = 'partial';
                                break;
                              }
                            }
                          }
                        });
                        renderHostels();
                      });
                } else {
                    // User is signed out
                    document.getElementById('authContainer').style.display = 'block';
                    document.getElementById('mainContainer').style.display = 'none';
                    showLogin(); // Show login form by default
                }
            });
        } else {
            console.error('Auth not initialized');
        }

        // Login function
        function login() {
            try {
                if (!isFirebaseInitialized()) {
                    throw new Error('Firebase not initialized');
                }
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        console.log('User logged in successfully');
                    })
                    .catch((error) => {
                        console.error('Login error:', error);
                        alert('Login failed: ' + error.message);
                    });
            } catch (error) {
                console.error('Login function error:', error);
                alert('Login function error: ' + error.message);
            }
        }

        // Register function
        function register() {
            try {
                if (!isFirebaseInitialized()) {
                    throw new Error('Firebase not initialized');
                }
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        console.log('User registered successfully');
                    })
                    .catch((error) => {
                        console.error('Registration error:', error);
                        alert('Registration failed: ' + error.message);
                    });
            } catch (error) {
                console.error('Register function error:', error);
                alert('Register function error: ' + error.message);
            }
        }

        // Logout function
        function logout() {
            try {
                if (!isFirebaseInitialized()) {
                    throw new Error('Firebase not initialized');
                }
                auth.signOut()
                    .then(() => {
                        console.log('User logged out successfully');
                    })
                    .catch((error) => {
                        console.error('Logout error:', error);
                    });
            } catch (error) {
                console.error('Logout function error:', error);
            }
        }
    </script>

    <script>
        // Helper functions for showing/hiding login/register forms
        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        // Helper to check if room is forbidden for females
        function isFemaleForbiddenRoom(roomKey, gender) {
            if (gender !== 'female') return false;
            const match = roomKey.match(/^Room (\d{3})$/);
            if (match) {
                const num = parseInt(match[1], 10);
                if (num >= 301 && num <= 310) return true;
            }
            return false;
        }

        // Allocation mode management
        let allocationMode = 'auto';
        
        function setAllocationMode(mode) {
            allocationMode = mode;
            
            // Update button styles
            const autoBtn = document.getElementById('autoModeBtn');
            const manualBtn = document.getElementById('manualModeBtn');
            
            if (mode === 'auto') {
                autoBtn.classList.remove('btn-secondary');
                autoBtn.classList.add('btn-primary');
                manualBtn.classList.remove('btn-primary');
                manualBtn.classList.add('btn-secondary');
                
                // Show auto form, hide manual form
                document.getElementById('autoForm').style.display = 'block';
                document.getElementById('manualForm').style.display = 'none';
            } else {
                manualBtn.classList.remove('btn-secondary');
                manualBtn.classList.add('btn-primary');
                autoBtn.classList.remove('btn-primary');
                autoBtn.classList.add('btn-secondary');
                
                // Show manual form, hide auto form
                document.getElementById('manualForm').style.display = 'block';
                document.getElementById('autoForm').style.display = 'none';
            }
        }

        // Populate manual room options based on hostel and gender
        function populateManualRoomOptions() {
            const hostelId = document.getElementById('manualHostelSelect').value;
            const gender = document.getElementById('manualGender').value;
            const roomSelect = document.getElementById('manualRoomSelect');
            
            // Clear existing options
            roomSelect.innerHTML = '<option value="">Select Room</option>';
            
            if (!hostelId || !gender) return;
            
            const rooms = hostelData[hostelId].rooms;
            
            for (const roomKey in rooms) {
                const room = rooms[roomKey];
                
                // Skip if room is full
                if (room.status === 'full') continue;
                
                // Check gender restrictions
                if (isFemaleForbiddenRoom(roomKey, gender)) continue;
                
                // Check gender separation: only show rooms that are empty or have only same-gender occupants
                let occupantsGender = [];
                if (room.gender1) occupantsGender.push(room.gender1);
                if (room.gender2) occupantsGender.push(room.gender2);
                if (room.gender3) occupantsGender.push(room.gender3);
                if (room.gender4) occupantsGender.push(room.gender4);
                
                if (occupantsGender.length > 0 && occupantsGender.some(g => g !== gender)) continue;
                
                // Gather occupant names
                let occupants = [];
                if (room.student1) occupants.push(room.student1);
                if (room.student2) occupants.push(room.student2);
                if (room.student3) occupants.push(room.student3);
                if (room.student4) occupants.push(room.student4);
                
                let occupantsText = occupants.length > 0 ? occupants.join(', ') : 'Empty';
                
                // Show price details if available
                let priceText = '';
                if (room.roomPrice != null && room.maintenanceFee != null) {
                    priceText = ` | ‚Çµ${room.roomPrice} + ‚Çµ${room.maintenanceFee}`;
                }
                
                // Option text
                let optionText = `${roomKey} (${room.occupancy}/${getTotalBeds(room)} beds) - [${occupantsText}]${priceText}`;
                roomSelect.innerHTML += `<option value="${roomKey}">${optionText}</option>`;
            }
        }

        // Helper function to get total beds in a room
        function getTotalBeds(room) {
            if ('student4' in room) return 4;
            if ('student3' in room) return 3;
            return 2;
        }
    </script>
</body>
</html>
