<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Hostel Slot Procurement System</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Authentication Container -->
    <div id="authContainer" style="display: none;">
        <div class="auth-wrapper">
            <div class="auth-box">
                <h2>üè¢ El Corazon Hostel</h2>
                <p>Please sign in to access the hostel management system</p>
                
                <!-- Login Form -->
                <div id="loginForm">
                    <h3>Sign In</h3>
                    <div class="input-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email">
                    </div>
                    <div class="input-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <button class="btn btn-primary" onclick="login()">Sign In</button>
                    <p>Don't have an account? <a href="#" onclick="showRegister()">Register here</a></p>
                </div>
                
                <!-- Register Form -->
                <div id="registerForm" style="display: none;">
                    <h3>Create Account</h3>
                    <div class="input-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" placeholder="Enter your email">
                    </div>
                    <div class="input-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" placeholder="Enter your password">
                    </div>
                    <button class="btn btn-success" onclick="register()">Create Account</button>
                    <p>Already have an account? <a href="#" onclick="showLogin()">Sign in here</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="mainContainer" style="display: none;">
    <div class="container">
        <div class="header">
            <h1>üè¢ El Corazon Hostel</h1>
            <p>Manage room allocations across multiple hostels</p>
                <div id="userInfo" style="margin-top: 10px; font-size: 0.9em;"></div>
                <button class="btn btn-danger" onclick="logout()" style="margin-top: 10px;">Logout</button>
        </div>

        <div class="controls">
            <div class="control-group">
                <button id="autoModeBtn" class="btn btn-primary" onclick="setAllocationMode('auto')">Auto</button>
                <button id="manualModeBtn" class="btn btn-secondary" onclick="setAllocationMode('manual')">Manual</button>
            </div>
            
            <!-- Search Section -->
            <div class="search-section">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search students, rooms, tenant codes..." onkeyup="performSearch()">
                    <button class="btn" onclick="performSearch()">üîç Search</button>
                    <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
                </div>
                <div id="searchResults" class="search-results" style="display: none;">
                    <!-- Search results will appear here -->
                </div>
            </div>
            
            <div id="autoForm" style="margin-top: 20px;">
                <div class="input-group">
                    <label for="autoStudentName">Student Name</label>
                    <input type="text" id="autoStudentName" placeholder="Enter student name">
                </div>
                <div class="input-group">
                    <label for="autoGender">Gender</label>
                    <select id="autoGender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="autoHostelSelect">Hostel</label>
                    <select id="autoHostelSelect" onchange="updatePricePreview('auto')">
                        <option value="">Select Hostel</option>
                        <option value="1">Hostel 1 (‚Çµ7,200 + ‚Çµ400)</option>
                        <option value="2">Hostel 2 (‚Çµ7,200-‚Çµ7,600 + ‚Çµ400)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Price Preview</label>
                    <div id="autoPricePreview" style="padding: 12px 16px; background: #f8f9fa; border-radius: 8px; font-weight: bold; color: #2c3e50;">Select hostel to see pricing</div>
                </div>
                <button class="btn btn-success" onclick="assignAutoSlot()">Procure Slot</button>
            </div>
            <div id="manualForm" style="margin-top: 20px; display: none;">
                <div class="input-group">
                    <label for="manualStudentName">Student Name</label>
                    <input type="text" id="manualStudentName" placeholder="Enter student name">
                </div>
                <div class="input-group">
                    <label for="manualGender">Gender</label>
                    <select id="manualGender" onchange="populateManualRoomOptions()">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="manualHostelSelect">Hostel</label>
                    <select id="manualHostelSelect" onchange="populateManualRoomOptions()">
                        <option value="">Select Hostel</option>
                        <option value="1">Hostel 1</option>
                        <option value="2">Hostel 2</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="manualRoomSelect">Room</label>
                    <select id="manualRoomSelect">
                        <option value="">Select Room</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="assignManualSlot()">Procure Slot</button>
            </div>
            <div class="control-group">
                <button class="btn" onclick="generateReport()">üìä Generate Report</button>
                <button class="btn" onclick="exportData()">üì§ Export Data</button>
                <button class="btn" onclick="exportExcel()">üì• Export to Excel</button>
                <button class="btn btn-danger" onclick="clearAllAllocations()">üóëÔ∏è Clear All</button>
            </div>
        </div>

        <div class="hostel-section">
            <div class="pull-refresh" id="pullRefresh">Pull down to refresh</div>
            <div class="stats" id="stats">
                <!-- Stats will be populated here -->
            </div>

            <div class="hostel-grid" id="hostelGrid">
                <!-- Hostels will be populated here -->
            </div>
        </div>
    </div>

    <!-- Modal for room details -->
    <div id="roomModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Room Details</h2>
            <div id="modalContent">
                <!-- Modal content will be populated here -->
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-danger" onclick="vacateRoom()" id="vacateBtn" style="display: none;">Vacate Room</button>
            </div>
        </div>
    </div>

    <!-- Mobile Floating Action Button -->
    <button class="fab" id="mobileFab" onclick="showMobileMenu()" style="display: none;">+</button>

    <!-- Mobile Menu Modal -->
    <div id="mobileMenuModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMobileMenu()">&times;</span>
            <h2>Quick Actions</h2>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <button class="btn btn-success" onclick="quickAssign()">Quick Assign</button>
                <button class="btn" onclick="showStats()">View Statistics</button>
                <button class="btn" onclick="exportData()">Export Data</button>
                <button class="btn btn-danger" onclick="clearAllAllocations()">Clear All</button>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading" id="loadingIndicator">
        <div style="text-align: center;">
            <div style="font-size: 24px; margin-bottom: 10px;">üîÑ</div>
            <div>Loading...</div>
        </div>
    </div>

    <!-- External Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Firebase Configuration and Authentication -->
    <script>
        // Hostel data structure
        let hostelData = {
            1: {
                name: "Hostel 1",
                rooms: {}
            },
            2: {
                name: "Hostel 2", 
                rooms: {}
            }
        };

        // Initialize hostels with room data
        function initializeHostels() {
            console.log('Initializing hostels...');
            
            // Generate rooms for both hostels with proper floor numbering
            // Ground floor: 101-110, First floor: 201-210, Third floor: 301-310
            const floors = [1, 2, 3]; // Ground, First, Third floors
            
            [1, 2].forEach(hostelId => {
                floors.forEach(floor => {
                    const floorPrefix = floor === 1 ? 1 : floor === 2 ? 2 : 3;
                    for (let room = 1; room <= 10; room++) {
                        const roomNumber = `${floorPrefix}${room < 10 ? '0' : ''}${room}`;
                        
                        // Calculate room price based on hostel and floor
                        let roomPrice;
                        if (hostelId === 1) {
                            roomPrice = 7200; // All floors of Hostel 1
                        } else { // Hostel 2
                            if (floor === 1) { // Ground floor
                                roomPrice = 7200;
                            } else { // First and Third floors
                                roomPrice = 7600;
                            }
                        }
                        
                        hostelData[hostelId].rooms[`Room ${roomNumber}`] = {
                            code: generateRoomCode(),
                            student1: null,
                            studentId1: null,
                            tenantCode1: null,
                            student2: null,
                            studentId2: null,
                            tenantCode2: null,
                            status: 'available', // available, partial, full, reserved
                            occupancy: 0,
                            roomPrice: roomPrice,
                            maintenanceFee: 400,
                            gender1: null, // For gender separation
                            gender2: null, // For gender separation
                            paid1: false, paid2: false,
                            paid3: false, paid4: false
                        };
                    }
                });
            });

            // Add special rooms for Hostel 2
            if (hostelData[2]) {
                // Room 211 (3 beds, no price)
                hostelData[2].rooms['Room 211'] = {
                    code: generateRoomCode(),
                    student1: null, student2: null, student3: null,
                    tenantCode1: null, tenantCode2: null, tenantCode3: null,
                    status: 'available', occupancy: 0,
                    roomPrice: null, maintenanceFee: null,
                    gender1: null, gender2: null, gender3: null,
                    paid1: false, paid2: false, paid3: false
                };
                // Room 401 (4 beds, no price)
                hostelData[2].rooms['Room 401'] = {
                    code: generateRoomCode(),
                    student1: null, student2: null, student3: null, student4: null,
                    tenantCode1: null, tenantCode2: null, tenantCode3: null, tenantCode4: null,
                    status: 'available', occupancy: 0,
                    roomPrice: null, maintenanceFee: null,
                    gender1: null, gender2: null, gender3: null, gender4: null,
                    paid1: false, paid2: false, paid3: false, paid4: false
                };
                // Room 402 (2 beds, no price)
                hostelData[2].rooms['Room 402'] = {
                    code: generateRoomCode(),
                    student1: null, student2: null,
                    tenantCode1: null, tenantCode2: null,
                    status: 'available', occupancy: 0,
                    roomPrice: null, maintenanceFee: null,
                    gender1: null, gender2: null,
                    paid1: false, paid2: false
                };
            }

            console.log('Hostels initialized with rooms:', Object.keys(hostelData[1].rooms).length, 'rooms in Hostel 1,', Object.keys(hostelData[2].rooms).length, 'rooms in Hostel 2');
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 3; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            code += '-';
            for (let i = 0; i < 4; i++) {
                code += Math.floor(Math.random() * 10);
            }
            return code;
        }

        // Declare Firebase variables in global scope
        let auth;
        let db;
        
        // Firebase configuration - Replace with your Firebase project config
        const firebaseConfig = {
            apiKey: "AIzaSyD9olGjCq2R5Ty-innj4b0ZSnJn-ztFV2I",
            authDomain: "el-corazonslots.firebaseapp.com",
            projectId: "el-corazonslots",
            storageBucket: "el-corazonslots.firebasestorage.app",
            messagingSenderId: "745745248762",
            appId: "1:745745248762:web:752704c94963518b1c7443",
            measurementId: "G-7Q0RQHVXX2"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore(); // Initialize Firestore
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Function to check if Firebase is initialized
        function isFirebaseInitialized() {
            return auth && db;
        }

        // Authentication state observer
        if (auth) {
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    // User is signed in
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    document.getElementById('userInfo').textContent = `Welcome, ${user.email}`;
                    
                    // Initialize the hostel system only when user is authenticated
                    initializeHostels();
                    
                    // Load users from Firestore and update hostel data
                    loadUsersFromFirestore().then(() => {
                        // Load persistent data from Google Sheets and update hostelData
                        fetch('https://script.google.com/macros/s/AKfycbxv62y2XpoapxBe_TMip29gS5VJBHUwYuDnmZIjYWZkCwd52Fs57bNiUkUrOecW9ZA2/exec')
                          .then(response => response.json())
                          .then(data => {
                            data.forEach(entry => {
                              // Convert Hostel and Room Number to match your keys
                              const hostelId = entry.Hostel;
                              const roomKey = `Room ${entry["Room Number"]}`;
                              // Find the first empty bed in the room
                              const room = hostelData[hostelId] && hostelData[hostelId].rooms[roomKey];
                              if (room) {
                                for (let i = 1; i <= 4; i++) {
                                  if (room[`student${i}`] === null || room[`student${i}`] === undefined) {
                                    room[`student${i}`] = entry.Name;
                                    room[`tenantCode${i}`] = entry.Token;
                                    room[`paid${i}`] = true; // Assume paid if it's in the sheet
                                    room.occupancy = (room.occupancy || 0) + 1;
                                    room.status = 'partial';
                                    break;
                                  }
                                }
                              }
                            });
                            renderHostels();
                          });
                    });
                } else {
                    // User is signed out
                    document.getElementById('authContainer').style.display = 'block';
                    document.getElementById('mainContainer').style.display = 'none';
                    showLogin(); // Show login form by default
                }
            });
                    } else {
            console.error('Auth not initialized');
        }

        // Login function
        function login() {
            try {
                if (!isFirebaseInitialized()) {
                    throw new Error('Firebase not initialized');
                }
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        console.log('User logged in successfully');
                    })
                    .catch((error) => {
                        console.error('Login error:', error);
                        alert('Login failed: ' + error.message);
                    });
            } catch (error) {
                console.error('Login function error:', error);
                alert('Login function error: ' + error.message);
            }
        }

        // Register function
        function register() {
            try {
                if (!isFirebaseInitialized()) {
                    throw new Error('Firebase not initialized');
                }
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        console.log('User registered successfully');
                    })
                    .catch((error) => {
                        console.error('Registration error:', error);
                        alert('Registration failed: ' + error.message);
                    });
            } catch (error) {
                console.error('Register function error:', error);
                alert('Register function error: ' + error.message);
            }
        }

        // Logout function
        function logout() {
            try {
                if (!isFirebaseInitialized()) {
                    throw new Error('Firebase not initialized');
                }
                auth.signOut()
                    .then(() => {
                        console.log('User logged out successfully');
                    })
                    .catch((error) => {
                        console.error('Logout error:', error);
                    });
            } catch (error) {
                console.error('Logout function error:', error);
            }
        }
    </script>

    <script>
        // Helper functions for showing/hiding login/register forms
        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        // Helper to check if room is forbidden for females
        function isFemaleForbiddenRoom(roomKey, gender) {
            if (gender !== 'female') return false;
            const match = roomKey.match(/^Room (\d{3})$/);
            if (match) {
                const num = parseInt(match[1], 10);
                if (num >= 301 && num <= 310) return true;
            }
            return false;
        }

        // Allocation mode management
        let allocationMode = 'auto';
        
        function setAllocationMode(mode) {
            allocationMode = mode;
            
            // Update button styles
            const autoBtn = document.getElementById('autoModeBtn');
            const manualBtn = document.getElementById('manualModeBtn');
            
            if (mode === 'auto') {
                autoBtn.classList.remove('btn-secondary');
                autoBtn.classList.add('btn-primary');
                manualBtn.classList.remove('btn-primary');
                manualBtn.classList.add('btn-secondary');
                
                // Show auto form, hide manual form
                document.getElementById('autoForm').style.display = 'block';
                document.getElementById('manualForm').style.display = 'none';
            } else {
                manualBtn.classList.remove('btn-secondary');
                manualBtn.classList.add('btn-primary');
                autoBtn.classList.remove('btn-primary');
                autoBtn.classList.add('btn-secondary');
                
                // Show manual form, hide auto form
                document.getElementById('manualForm').style.display = 'block';
                document.getElementById('autoForm').style.display = 'none';
            }
        }

        // Populate manual room options based on hostel and gender
        function populateManualRoomOptions() {
            console.log('populateManualRoomOptions called');
            
            const hostelId = document.getElementById('manualHostelSelect').value;
            const gender = document.getElementById('manualGender').value;
            const roomSelect = document.getElementById('manualRoomSelect');
            
            console.log('Hostel ID:', hostelId);
            console.log('Gender:', gender);
            console.log('Room Select Element:', roomSelect);
            
            // Clear existing options
            roomSelect.innerHTML = '<option value="">Select Room</option>';
            
            if (!hostelId || !gender) {
                console.log('Missing hostel or gender selection');
                return;
            }
            
            if (!hostelData[hostelId]) {
                console.log('Hostel data not found for ID:', hostelId);
                return;
            }
            
            const rooms = hostelData[hostelId].rooms;
            console.log('Available rooms:', Object.keys(rooms));
            
            let availableRooms = 0;
            
            for (const roomKey in rooms) {
                const room = rooms[roomKey];
                
                // Skip if room is full
                if (room.status === 'full') {
                    console.log('Skipping full room:', roomKey);
                    continue;
                }
                
                // Check gender restrictions
                if (isFemaleForbiddenRoom(roomKey, gender)) {
                    console.log('Skipping gender-restricted room:', roomKey);
                    continue;
                }
                
                // Check gender separation: only show rooms that are empty or have only same-gender occupants
                let occupantsGender = [];
                if (room.gender1) occupantsGender.push(room.gender1);
                if (room.gender2) occupantsGender.push(room.gender2);
                if (room.gender3) occupantsGender.push(room.gender3);
                if (room.gender4) occupantsGender.push(room.gender4);
                
                if (occupantsGender.length > 0 && occupantsGender.some(g => g !== gender)) {
                    console.log('Skipping room with mixed genders:', roomKey);
                    continue;
                }
                
                // Gather occupant names
                let occupants = [];
                if (room.student1) occupants.push(room.student1);
                if (room.student2) occupants.push(room.student2);
                if (room.student3) occupants.push(room.student3);
                if (room.student4) occupants.push(room.student4);
                
                let occupantsText = occupants.length > 0 ? occupants.join(', ') : 'Empty';
                
                // Show price details if available
                let priceText = '';
                if (room.roomPrice != null && room.maintenanceFee != null) {
                    priceText = ` | ‚Çµ${room.roomPrice} + ‚Çµ${room.maintenanceFee}`;
                }
                
                // Option text
                let optionText = `${roomKey} (${room.occupancy}/${getTotalBeds(room)} beds) - [${occupantsText}]${priceText}`;
                roomSelect.innerHTML += `<option value="${roomKey}">${optionText}</option>`;
                availableRooms++;
                console.log('Added room option:', roomKey);
            }
            
            console.log('Total available rooms added:', availableRooms);
        }

        // Helper function to get total beds in a room
        function getTotalBeds(room) {
            if ('student4' in room) return 4;
            if ('student3' in room) return 3;
            return 2;
        }

        // Firestore Database Functions
        // Save user details to Firestore
        async function saveUserToFirestore(name, hostel, roomNumber, token) {
            try {
                if (!isFirebaseInitialized()) {
                    throw new Error('Firebase not initialized');
                }
                
                const userData = {
                    name: name,
                    hostel: hostel,
                    roomNumber: roomNumber,
                    token: token,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('users').add(userData);
                console.log('User saved to Firestore with ID:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('Error saving user to Firestore:', error);
                throw error;
            }
        }

        // Get all users from Firestore
        async function getUsersFromFirestore() {
            try {
                if (!isFirebaseInitialized()) {
                    throw new Error('Firebase not initialized');
                }
                
                const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                const users = [];
                
                snapshot.forEach(doc => {
                    users.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log('Retrieved users from Firestore:', users.length);
                return users;
            } catch (error) {
                console.error('Error getting users from Firestore:', error);
                throw error;
            }
        }

        // Update user in Firestore
        async function updateUserInFirestore(userId, updatedData) {
            try {
                if (!isFirebaseInitialized()) {
                    throw new Error('Firebase not initialized');
                }
                
                const updateData = {
                    ...updatedData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(userId).update(updateData);
                console.log('User updated in Firestore:', userId);
            } catch (error) {
                console.error('Error updating user in Firestore:', error);
                throw error;
            }
        }

        // Delete user from Firestore
        async function deleteUserFromFirestore(userId) {
            try {
                if (!isFirebaseInitialized()) {
                    throw new Error('Firebase not initialized');
                }
                
                await db.collection('users').doc(userId).delete();
                console.log('User deleted from Firestore:', userId);
            } catch (error) {
                console.error('Error deleting user from Firestore:', error);
                throw error;
            }
        }

        // Load users from Firestore and update hostel data
        async function loadUsersFromFirestore() {
            try {
                const users = await getUsersFromFirestore();
                
                users.forEach(user => {
                    const hostelId = user.hostel;
                    const roomKey = `Room ${user.roomNumber}`;
                    
                    if (hostelData[hostelId] && hostelData[hostelId].rooms[roomKey]) {
                        const room = hostelData[hostelId].rooms[roomKey];
                        
                        // Find first available bed
                        for (let i = 1; i <= 4; i++) {
                            if (!room[`student${i}`]) {
                                room[`student${i}`] = user.name;
                                room[`tenantCode${i}`] = user.token;
                                room.occupancy = (room.occupancy || 0) + 1;
                                room.status = room.occupancy === getTotalBeds(room) ? 'full' : 'partial';
                                break;
                            }
                        }
                    }
                });
                
                console.log('Users loaded from Firestore and hostel data updated');
            } catch (error) {
                console.error('Error loading users from Firestore:', error);
            }
        }

        // Auto allocation function
        async function assignAutoSlot() {
            try {
            const studentName = document.getElementById('autoStudentName').value.trim();
            const gender = document.getElementById('autoGender').value;
            const hostelId = document.getElementById('autoHostelSelect').value;
                
            if (!studentName || !hostelId || !gender) {
                alert('Please fill in all fields');
                return;
            }
                
            const hostel = hostelData[hostelId];
            let assignedRoom = null;
                let tenantCode = generateRoomCode();
            let assignedBed = null;
                
            // Try to fill partial rooms first
            for (let roomKey in hostel.rooms) {
                if (isFemaleForbiddenRoom(roomKey, gender)) continue;
                const room = hostel.rooms[roomKey];
                if (room.status === 'partial') {
                    // Gender separation: only assign if existing occupant is same gender
                    if ((room.gender1 && room.gender1 !== gender) || (room.gender2 && room.gender2 !== gender)) continue;
                    room.student2 = studentName;
                    room.tenantCode2 = tenantCode;
                    room.gender2 = gender;
                    room.status = 'full';
                    room.occupancy = 2;
                    assignedRoom = roomKey;
                    assignedBed = 2;
                    break;
                }
            }
                
            // If no partial rooms, assign to available room
            if (!assignedRoom) {
                for (let roomKey in hostel.rooms) {
                    if (isFemaleForbiddenRoom(roomKey, gender)) continue;
                    const room = hostel.rooms[roomKey];
                    if (room.status === 'available') {
                        room.student1 = studentName;
                        room.tenantCode1 = tenantCode;
                        room.gender1 = gender;
                        room.status = 'partial';
                        room.occupancy = 1;
                        assignedRoom = roomKey;
                        assignedBed = 1;
                        break;
                    }
                }
            }
                
            if (assignedRoom) {
                    // Save to Firestore
                    const roomNumber = assignedRoom.replace('Room ', '');
                    await saveUserToFirestore(studentName, hostelId, roomNumber, tenantCode);
                    
                    // Save to Google Sheets
                    fetch('https://script.google.com/macros/s/AKfycbxv62y2XpoapxBe_TMip29gS5VJBHUwYuDnmZIjYWZkCwd52Fs57bNiUkUrOecW9ZA2/exec', {
                        method: 'POST',
                        body: JSON.stringify({
                            name: studentName,
                            room: roomNumber,
                            hostel: hostelId,
                            token: tenantCode
                        }),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                alert(`Assigned ${studentName} to ${assignedRoom} (Bed ${assignedBed}) in Hostel ${hostelId}.\nTenant Token: ${tenantCode}`);
                document.getElementById('autoStudentName').value = '';
                document.getElementById('autoGender').value = '';
                renderHostels();
            } else {
                alert('No available beds in selected hostel for the selected gender');
            }
            } catch (error) {
                console.error('Error in assignAutoSlot:', error);
                alert('Error assigning slot: ' + error.message);
            }
        }

        // Manual allocation function
        async function assignManualSlot() {
            try {
            const studentName = document.getElementById('manualStudentName').value.trim();
            const gender = document.getElementById('manualGender').value;
            const hostelId = document.getElementById('manualHostelSelect').value;
            const roomKey = document.getElementById('manualRoomSelect').value;
                
            if (!studentName || !hostelId || !roomKey || !gender) {
                alert('Please fill in all fields');
                return;
            }
                
            if (isFemaleForbiddenRoom(roomKey, gender)) {
                alert('Females cannot be assigned to rooms 301-310.');
                return;
            }
                
            const room = hostelData[hostelId].rooms[roomKey];
                
            // Gender separation: only assign if room is empty or all occupants are same gender
            let occupantsGender = [];
            if (room.gender1) occupantsGender.push(room.gender1);
            if (room.gender2) occupantsGender.push(room.gender2);
            if (occupantsGender.length > 0 && occupantsGender.some(g => g !== gender)) {
                alert('Cannot mix genders in a room.');
                return;
            }
                
                const tenantCode = generateRoomCode();
            let assignedBed = null;
                
            if (!room.student1) {
                room.student1 = studentName;
                room.tenantCode1 = tenantCode;
                room.gender1 = gender;
                room.status = room.student2 ? 'partial' : 'partial';
                room.occupancy = room.student2 ? 2 : 1;
                assignedBed = 1;
            } else if (!room.student2) {
                room.student2 = studentName;
                room.tenantCode2 = tenantCode;
                room.gender2 = gender;
                room.status = 'full';
                room.occupancy = 2;
                assignedBed = 2;
            } else {
                alert('Room is already full');
                return;
            }
                
                // Save to Firestore
                const roomNumber = roomKey.replace('Room ', '');
                await saveUserToFirestore(studentName, hostelId, roomNumber, tenantCode);
                
                // Save to Google Sheets
                fetch('https://script.google.com/macros/s/AKfycbxv62y2XpoapxBe_TMip29gS5VJBHUwYuDnmZIjYWZkCwd52Fs57bNiUkUrOecW9ZA2/exec', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: studentName,
                        room: roomNumber,
                        hostel: hostelId,
                        token: tenantCode
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
            alert(`Assigned ${studentName} to ${roomKey} (Bed ${assignedBed}) in Hostel ${hostelId}.\nTenant Token: ${tenantCode}`);
            document.getElementById('manualStudentName').value = '';
            document.getElementById('manualGender').value = '';
            document.getElementById('manualHostelSelect').value = '';
            document.getElementById('manualRoomSelect').innerHTML = '<option value="">Select Room</option>';
            renderHostels();
            } catch (error) {
                console.error('Error in assignManualSlot:', error);
                alert('Error assigning slot: ' + error.message);
            }
        }

        // Render hostels function
        function renderHostels() {
            console.log('Rendering hostels...');
            const grid = document.getElementById('hostelGrid');
            if (!grid) {
                console.error('Hostel grid element not found');
                return;
            }
            
            grid.innerHTML = '';

            Object.keys(hostelData).forEach(hostelId => {
                const hostel = hostelData[hostelId];
                const hostelDiv = document.createElement('div');
                hostelDiv.className = 'hostel';
                
                hostelDiv.innerHTML = `
                    <div class="hostel-header">${hostel.name}</div>
                    <div class="room-grid" id="rooms-${hostelId}">
                        ${renderRooms(hostelId)}
                    </div>
                `;
                
                grid.appendChild(hostelDiv);
            });

            updateStats();
        }

        // Render rooms for a specific hostel
        function renderRooms(hostelId) {
            const rooms = hostelData[hostelId].rooms;
            return Object.keys(rooms).map(roomKey => {
                const room = rooms[roomKey];
                let displayText = '';
                let priceInfo = '';
                
                if (room.status === 'available') {
                    displayText = 'Available';
                    if (room.roomPrice != null && room.maintenanceFee != null) {
                        priceInfo = `‚Çµ${room.roomPrice} + ‚Çµ${room.maintenanceFee}`;
                    } else {
                        priceInfo = '';
                    }
                } else if (room.status === 'partial') {
                    displayText = room.student1 || 'Partial';
                    priceInfo = `${room.occupancy}/${getTotalBeds(room)} occupied`;
                } else if (room.status === 'full') {
                    displayText = `${room.student1 || ''}<br>${room.student2 || ''}`;
                    priceInfo = `${room.occupancy}/${getTotalBeds(room)} occupied`;
                } else if (room.status === 'reserved') {
                    displayText = 'Reserved';
                    priceInfo = 'Reserved';
                }
                
                return `
                    <div class="room ${room.status}" onclick="showRoomDetails('${hostelId}', '${roomKey}')">
                        <div class="room-code">${roomKey}</div>
                        <div class="student-name">${displayText}</div>
                        <div class="student-id">${priceInfo}</div>
                    </div>
                `;
            }).join('');
        }

        // Update statistics
        function updateStats() {
            let totalRooms = 0;
            let availableRooms = 0;
            let partialRooms = 0;
            let fullRooms = 0;
            let reservedRooms = 0;

            Object.values(hostelData).forEach(hostel => {
                Object.values(hostel.rooms).forEach(room => {
                    totalRooms++;
                    switch(room.status) {
                        case 'available': availableRooms++; break;
                        case 'partial': partialRooms++; break;
                        case 'full': fullRooms++; break;
                        case 'reserved': reservedRooms++; break;
                    }
                });
            });

            const statsElement = document.getElementById('stats');
            if (statsElement) {
                statsElement.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number total-stat">${totalRooms}</div>
                        <div class="stat-label">Total Rooms</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number available-stat">${availableRooms}</div>
                        <div class="stat-label">Available</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number occupied-stat">${partialRooms}</div>
                        <div class="stat-label">Partial (1/2)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number occupied-stat">${fullRooms}</div>
                        <div class="stat-label">Full (2/2)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number reserved-stat">${reservedRooms}</div>
                        <div class="stat-label">Reserved</div>
                    </div>
                `;
            }
        }

        // Show room details modal
        function showRoomDetails(hostelId, roomKey) {
            const room = hostelData[hostelId].rooms[roomKey];
            if (!room) return;

            const modal = document.getElementById('roomModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');

            modalTitle.textContent = `${roomKey} - Hostel ${hostelId}`;
            
            let bedCount = getTotalBeds(room);
            let bedsHtml = '';
            
            for (let i = 1; i <= bedCount; i++) {
                const student = room[`student${i}`];
                const tenantCode = room[`tenantCode${i}`];
                const paid = room[`paid${i}`];
                
                if (student) {
                    const paidIcon = paid ? '‚úÖ' : '‚ùå';
                    const paidText = paid ? 'Paid' : 'Unpaid';
                    bedsHtml += `
                        <div class="bed-info" style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px;">
                            <strong>Bed ${i}:</strong> ${student} ${paidIcon} (${paidText})<br>
                            <small>Token: ${tenantCode || 'N/A'}</small><br>
                            <button class="btn btn-sm" onclick="togglePaidStatus(${i})" style="margin: 2px;">
                                Mark as ${paid ? 'Unpaid' : 'Paid'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="removeTenant(${i})" style="margin: 2px;">
                                Remove
                            </button>
                        </div>
                    `;
            } else {
                    bedsHtml += `
                        <div class="bed-info" style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px; background-color: #f9f9f9;">
                            <strong>Bed ${i}:</strong> Available<br>
                            <button class="btn btn-sm btn-success" onclick="showBedAssignmentForm(${i}, '${hostelId}', '${roomKey}')" style="margin: 2px;">
                                Assign Student
                            </button>
                        </div>
                    `;
                }
            }

            modalContent.innerHTML = `
                <div class="room-details">
                    <p><strong>Status:</strong> ${room.status}</p>
                    <p><strong>Occupancy:</strong> ${room.occupancy}/${bedCount}</p>
                    ${room.roomPrice ? `<p><strong>Price:</strong> ‚Çµ${room.roomPrice} + ‚Çµ${room.maintenanceFee}</p>` : ''}
                    <div class="beds-container">
                        ${bedsHtml}
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-danger" onclick="vacateRoom()">Vacate Entire Room</button>
                    </div>
                </div>
            `;

            modal.style.display = 'block';
        }

        // Show bed assignment form
        function showBedAssignmentForm(bedNumber, hostelId, roomKey) {
            const modal = document.getElementById('roomModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');

            modalTitle.textContent = `Assign Student to Bed ${bedNumber} - ${roomKey}`;
            
            modalContent.innerHTML = `
                <div class="bed-assignment-form">
                    <div class="input-group" style="margin-bottom: 15px;">
                        <label for="bedStudentName">Student Name</label>
                        <input type="text" id="bedStudentName" placeholder="Enter student name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div class="input-group" style="margin-bottom: 15px;">
                        <label for="bedGender">Gender</label>
                        <select id="bedGender" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-success" onclick="assignStudentToBed(${bedNumber}, '${hostelId}', '${roomKey}')" style="margin-right: 10px;">
                            Assign Student
                        </button>
                        <button class="btn btn-secondary" onclick="showRoomDetails('${hostelId}', '${roomKey}')">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
        }

        // Assign student to specific bed
        async function assignStudentToBed(bedNumber, hostelId, roomKey) {
            try {
                const studentName = document.getElementById('bedStudentName').value.trim();
                const gender = document.getElementById('bedGender').value;
                
                if (!studentName || !gender) {
                    alert('Please fill in all fields');
                    return;
                }
                
                const room = hostelData[hostelId].rooms[roomKey];
                if (!room) {
                    alert('Room not found');
                    return;
                }
                
                // Check if bed is already occupied
                if (room[`student${bedNumber}`]) {
                    alert(`Bed ${bedNumber} is already occupied by ${room[`student${bedNumber}`]}`);
                    return;
                }
                
                // Check gender restrictions for females
            if (isFemaleForbiddenRoom(roomKey, gender)) {
                alert('Females cannot be assigned to rooms 301-310.');
                return;
            }
                
                // Check gender separation: only assign if room is empty or all occupants are same gender
            let occupantsGender = [];
                for (let i = 1; i <= getTotalBeds(room); i++) {
                    if (i !== bedNumber && room[`gender${i}`]) {
                        occupantsGender.push(room[`gender${i}`]);
            }
                }
                
            if (occupantsGender.length > 0 && occupantsGender.some(g => g !== gender)) {
                alert('Cannot mix genders in a room.');
                return;
            }
                
                // Generate tenant code
                const tenantCode = generateRoomCode();
                
                // Assign student to bed
                room[`student${bedNumber}`] = studentName;
                room[`tenantCode${bedNumber}`] = tenantCode;
                room[`gender${bedNumber}`] = gender;
                room[`paid${bedNumber}`] = false;
                
                // Update room occupancy and status
                let totalBeds = getTotalBeds(room);
                let occupiedBeds = 0;
                
            for (let i = 1; i <= totalBeds; i++) {
                    if (room[`student${i}`]) {
                        occupiedBeds++;
                    }
                }
                
                room.occupancy = occupiedBeds;
                
                if (occupiedBeds === totalBeds) {
                room.status = 'full';
                } else if (occupiedBeds > 0) {
                room.status = 'partial';
            } else {
                room.status = 'available';
            }
                
                // Save to Firestore
                const roomNumber = roomKey.replace('Room ', '');
                await saveUserToFirestore(studentName, hostelId, roomNumber, tenantCode);
                
                // Save to Google Sheets
                fetch('https://script.google.com/macros/s/AKfycbxv62y2XpoapxBe_TMip29gS5VJBHUwYuDnmZIjYWZkCwd52Fs57bNiUkUrOecW9ZA2/exec', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: studentName,
                        room: roomNumber,
                        hostel: hostelId,
                        token: tenantCode
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                alert(`Successfully assigned ${studentName} to Bed ${bedNumber} in ${roomKey}.\nTenant Token: ${tenantCode}`);
                
                // Refresh the room details and hostel display
            showRoomDetails(hostelId, roomKey);
                renderHostels();
                
            } catch (error) {
                console.error('Error assigning student to bed:', error);
                alert('Error assigning student: ' + error.message);
            }
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('roomModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Toggle paid status for a bed
        function togglePaidStatus(bedNumber) {
            try {
                const modal = document.getElementById('roomModal');
                const modalTitle = document.getElementById('modalTitle');
                const roomKey = modalTitle.textContent.split(' - ')[0];
                const hostelId = modalTitle.textContent.split(' - ')[1].replace('Hostel ', '');
                
            const room = hostelData[hostelId].rooms[roomKey];
                if (!room) {
                    console.error('Room not found:', roomKey);
                    return;
                }

                const student = room[`student${bedNumber}`];
                if (!student) {
                    alert('No student assigned to this bed');
                    return;
                }

                // Toggle paid status
                const currentPaidStatus = room[`paid${bedNumber}`];
                room[`paid${bedNumber}`] = !currentPaidStatus;

                // If marking as paid, save to Google Sheets
                if (!currentPaidStatus) {
                    const tenantCode = room[`tenantCode${bedNumber}`];
                    const roomNumber = roomKey.replace('Room ', '');
                    
                    fetch('https://script.google.com/macros/s/AKfycbxv62y2XpoapxBe_TMip29gS5VJBHUwYuDnmZIjYWZkCwd52Fs57bNiUkUrOecW9ZA2/exec', {
                        method: 'POST',
                        body: JSON.stringify({
                            name: student,
                            room: roomNumber,
                            hostel: hostelId,
                            token: tenantCode
                        }),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                }

                // Refresh the modal to show updated status
                showRoomDetails(hostelId, roomKey);
                
                console.log(`Bed ${bedNumber} payment status toggled to: ${room[`paid${bedNumber}`]}`);
            } catch (error) {
                console.error('Error toggling paid status:', error);
                alert('Error updating payment status: ' + error.message);
            }
        }

        // Remove tenant from a bed
        function removeTenant(bedNumber) {
            try {
                const modal = document.getElementById('roomModal');
                const modalTitle = document.getElementById('modalTitle');
                const roomKey = modalTitle.textContent.split(' - ')[0];
                const hostelId = modalTitle.textContent.split(' - ')[1].replace('Hostel ', '');
                
            const room = hostelData[hostelId].rooms[roomKey];
                if (!room) {
                    console.error('Room not found:', roomKey);
                    return;
                }

                const student = room[`student${bedNumber}`];
                if (!student) {
                    alert('No student assigned to this bed');
                    return;
                }

                if (confirm(`Are you sure you want to remove ${student} from Bed ${bedNumber}?`)) {
                    // Clear the bed
            room[`student${bedNumber}`] = null;
            room[`tenantCode${bedNumber}`] = null;
            room[`gender${bedNumber}`] = null;
            room[`paid${bedNumber}`] = false;

                    // Update room occupancy and status
                    let totalBeds = getTotalBeds(room);
                    let occupiedBeds = 0;
                    
            for (let i = 1; i <= totalBeds; i++) {
                        if (room[`student${i}`]) {
                            occupiedBeds++;
                        }
                    }
                    
                    room.occupancy = occupiedBeds;
                    
                    if (occupiedBeds === 0) {
                        room.status = 'available';
                    } else if (occupiedBeds < totalBeds) {
                room.status = 'partial';
            } else {
                        room.status = 'full';
            }

                    // Refresh the modal and hostel display
            showRoomDetails(hostelId, roomKey);
                    renderHostels();
                    
                    alert(`${student} has been removed from Bed ${bedNumber}`);
                }
            } catch (error) {
                console.error('Error removing tenant:', error);
                alert('Error removing tenant: ' + error.message);
            }
        }

        // Clear all allocations
        function clearAllAllocations() {
            if (confirm('Are you sure you want to clear all room allocations? This cannot be undone.')) {
                try {
                    Object.values(hostelData).forEach(hostel => {
                        Object.values(hostel.rooms).forEach(room => {
                            // Clear all student data
                            room.student1 = null;
                            room.studentId1 = null;
                            room.tenantCode1 = null;
                            room.student2 = null;
                            room.studentId2 = null;
                            room.tenantCode2 = null;
                            room.student3 = null;
                            room.tenantCode3 = null;
                            room.student4 = null;
                            room.tenantCode4 = null;
                            
                            // Reset room status
                            room.status = 'available';
                            room.occupancy = 0;
                            
                            // Clear gender and payment data
                            room.gender1 = null;
                            room.gender2 = null;
                            room.gender3 = null;
                            room.gender4 = null;
                            room.paid1 = false;
                            room.paid2 = false;
                            room.paid3 = false;
                            room.paid4 = false;
                        });
                    });
                    
                    renderHostels();
                    alert('All allocations cleared - all slots are now vacant');
                } catch (error) {
                    console.error('Error clearing allocations:', error);
                    alert('Error clearing allocations: ' + error.message);
                }
            }
        }

        // Vacate room (remove all occupants)
        function vacateRoom() {
            try {
            const modal = document.getElementById('roomModal');
                const modalTitle = document.getElementById('modalTitle');
                const roomKey = modalTitle.textContent.split(' - ')[0];
                const hostelId = modalTitle.textContent.split(' - ')[1].replace('Hostel ', '');
                
                const room = hostelData[hostelId].rooms[roomKey];
                if (!room) {
                    console.error('Room not found:', roomKey);
                    return;
                }

                let totalBeds = getTotalBeds(room);
                let occupiedBeds = 0;
                let occupants = [];
                
                for (let i = 1; i <= totalBeds; i++) {
                    if (room[`student${i}`]) {
                        occupiedBeds++;
                        occupants.push(room[`student${i}`]);
                    }
                }

                if (occupiedBeds === 0) {
                    alert('This room is already empty');
                    return;
                }

                if (confirm(`Are you sure you want to vacate ${roomKey}? This will remove: ${occupants.join(', ')}`)) {
                    // Clear all beds in the room
                    for (let i = 1; i <= totalBeds; i++) {
                        room[`student${i}`] = null;
                        room[`tenantCode${i}`] = null;
                        room[`gender${i}`] = null;
                        room[`paid${i}`] = false;
                    }
                    
                    // Reset room status
                    room.status = 'available';
                    room.occupancy = 0;

                    // Refresh the modal and hostel display
                    showRoomDetails(hostelId, roomKey);
        renderHostels();

                    alert(`${roomKey} has been vacated`);
                }
            } catch (error) {
                console.error('Error vacating room:', error);
                alert('Error vacating room: ' + error.message);
            }
        }
    </script>
</body>
</html>
